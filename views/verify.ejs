<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Verificaci√≥n ¬∑ <%= org.name %></title>
  <style>
    *,*::before,*::after{box-sizing:border-box}
    body{margin:0;background:#fff;color:#111827;font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    a{color:#111;text-decoration:none} a:hover{text-decoration:underline}
    .center{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{width:100%;max-width:560px;background:#fff;border:1px solid #e5e7eb;border-radius:20px;padding:28px}
    .icon{width:64px;height:64px;border-radius:999px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;margin:0 auto 10px;font-size:24px}
    h1{font-size:1.8rem;line-height:1.2;text-align:center;margin:0 0 6px}
    .sub{color:#6b7280;text-align:center;margin-bottom:12px}
    .otp{display:flex;gap:10px;justify-content:center;margin:14px 0}
    .otp input{width:56px;height:66px;text-align:center;font-size:28px;font-weight:700;border:1px solid #e5e7eb;border-radius:12px}
    .otp input:focus{outline:2px solid #111;border-color:#111}
    .btn{cursor:pointer;border:1px solid #e5e7eb;background:#fff;padding:10px 14px;border-radius:10px}
    .btn.primary{background:#111;color:#fff;border-color:#111;font-weight:600}
    .btn.link{background:transparent;border:none;color:#111;padding:0}
    .wide{min-width:220px}
    .foot{display:flex;gap:10px;justify-content:center;align-items:center;color:#6b7280;margin-top:8px;flex-wrap:wrap}
    .err{margin-top:8px;color:#b91c1c;text-align:center}
  </style>
</head>
<body>
  <main class="center">
    <div class="card" role="dialog" aria-labelledby="t">
      <div class="icon"><%= channel==='email' ? '‚úâÔ∏è' : 'üì±' %></div>
      <h1 id="t"><%= channel==='email' ? 'Te hemos enviado un correo electr√≥nico' : 'Te hemos enviado un mensaje de texto' %></h1>
      <p class="sub">Introduce el c√≥digo de <%= OTP_LENGTH %> d√≠gitos enviado a <strong><%= identityMasked %></strong>.</p>

      <form id="otpForm" autocomplete="one-time-code">
        <div class="otp" id="otpGrid">
          <% for (let i=0;i<OTP_LENGTH;i++){ %>
            <input inputmode="numeric" pattern="[0-9]*" maxlength="1" aria-label="D√≠gito <%= i+1 %>"/>
          <% } %>
        </div>
        <div style="display:flex;justify-content:center"><button class="btn primary wide" id="verifyBtn">Verificar</button></div>
        <div class="foot">
          <span id="timer">15:00</span>
          <button type="button" class="btn link" id="resendBtn">Reenviar c√≥digo</button>
          <% if (channel==='whatsapp') { %>
            ¬∑ <a class="btn link" href="/verify?channel=email&identity=<%= encodeURIComponent(identityRaw) %>">Enviar al correo</a>
          <% } else { %>
            ¬∑ <a class="btn link" href="/verify?channel=whatsapp&identity=<%= encodeURIComponent(identityRaw) %>">Enviar por WhatsApp</a>
          <% } %>
        </div>
        <div id="errorBox" class="err" role="alert" style="display:none"></div>
      </form>
    </div>
  </main>

  <script>
    const OTP_LENGTH = <%= OTP_LENGTH %>;
    const channel = '<%= channel %>';
    const identity = '<%= identityRaw %>';
    localStorage.setItem('agendador_session_channel', channel);
    localStorage.setItem('agendador_session_identity', identity);

    const inputs = Array.from(document.querySelectorAll('#otpGrid input'));
    const errorBox = document.getElementById('errorBox');
    const timerEl = document.getElementById('timer');
    inputs[0].focus();

    inputs.forEach((inp,i)=>{
      inp.addEventListener('input', e=>{
        e.target.value = e.target.value.replace(/\D/g,'').slice(0,1);
        if (e.target.value && i<inputs.length-1) inputs[i+1].focus();
        errorBox.style.display='none';
      });
      inp.addEventListener('keydown', e=>{
        if (e.key==='Backspace' && !inp.value && i>0) inputs[i-1].focus();
      });
      inp.addEventListener('paste', e=>{
        const data=(e.clipboardData||window.clipboardData).getData('text').replace(/\D/g,'').slice(0,OTP_LENGTH);
        if(!data) return;
        e.preventDefault();
        inputs.forEach((n,j)=> n.value = data[j]||'');
        inputs[Math.min(data.length-1, OTP_LENGTH-1)]?.focus();
      });
    });

    let rem=15*60; setInterval(()=>{ rem=Math.max(0,rem-1);
      const m=String(Math.floor(rem/60)).padStart(2,'0'), s=String(rem%60).padStart(2,'0');
      timerEl.textContent=`${m}:${s}`;
    },1000);

    document.getElementById('otpForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const code = inputs.map(i=>i.value).join('');
      if (code.length!==OTP_LENGTH){ showErr('C√≥digo incompleto'); return; }
      const body = { code }; if (channel==='email') body.email=identity; else body.phone=identity;
      const r = await fetch('/auth/verify',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      const j = await r.json();
      if (!j.ok) return showErr(j.error || 'No se pudo verificar');
      location.href = '/';
    });

    document.getElementById('resendBtn').onclick = async ()=>{
      const body = { channel, name:'Cliente' }; if (channel==='email') body.email=identity; else body.phone=identity;
      const r=await fetch('/auth/send-code',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      const j=await r.json(); if (!j.ok) return showErr(j.error||'No se pudo reenviar');
      rem=15*60; alert('C√≥digo reenviado ‚úÖ');
    };

    function showErr(m){ errorBox.textContent = '‚ùå '+m; errorBox.style.display='block'; }
  </script>
</body>
</html>
