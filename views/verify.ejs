<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Verificaci√≥n ¬∑ <%= org.name %></title>
  <link rel="stylesheet" href="<%= cdn %>/styles.css"/>
</head>
<body class="center-stack">
  <div class="verify-card">
    <div class="veri-icon"><%= channel==='email' ? '‚úâÔ∏è' : 'üì±' %></div>
    <h1 class="veri-title"><%= channel==='email' ? 'Te hemos enviado un correo electr√≥nico' : 'Te hemos enviado un mensaje de texto' %></h1>
    <p class="veri-sub">Introduce el c√≥digo de <%= OTP_LENGTH %> d√≠gitos que hemos enviado a <strong><%= identityMasked %></strong>.</p>

    <form id="otpForm" autocomplete="one-time-code">
      <div class="otp-grid" id="otpGrid">
        <% for (let i=0;i<OTP_LENGTH;i++){ %>
          <input inputmode="numeric" pattern="[0-9]*" maxlength="1" aria-label="D√≠gito <%= i+1 %>" />
        <% } %>
      </div>
      <button class="btn primary wide" id="verifyBtn">Verificar</button>
      <div class="veri-foot">
        <span id="timer">15:00</span>
        <button type="button" class="btn link" id="resendBtn">Reenviar c√≥digo</button>
        <% if (channel==='whatsapp') { %>
          ¬∑ <a class="btn link" href="/verify?channel=email&identity=<%= encodeURIComponent(identityRaw) %>">Enviar al correo</a>
        <% } else { %>
          ¬∑ <a class="btn link" href="/verify?channel=whatsapp&identity=<%= encodeURIComponent(identityRaw) %>">Enviar por WhatsApp</a>
        <% } %>
      </div>
      <div id="errorBox" class="error" role="alert" style="display:none"></div>
    </form>
  </div>

  <script>
    const OTP_LENGTH = <%= OTP_LENGTH %>;
    const channel = '<%= channel %>';
    const identity = '<%= identityRaw %>';
    localStorage.setItem('agendador_session_channel', channel);
    localStorage.setItem('agendador_session_identity', identity);

    const inputs = Array.from(document.querySelectorAll('#otpGrid input'));
    const errorBox = document.getElementById('errorBox');
    const timerEl = document.getElementById('timer');

    inputs[0].focus();
    inputs.forEach((inp, i)=>{
      inp.addEventListener('input', e=>{
        e.target.value = e.target.value.replace(/\D/g,'').slice(0,1);
        if (e.target.value && i<inputs.length-1) inputs[i+1].focus();
        errorBox.style.display='none';
      });
      inp.addEventListener('keydown', e=>{
        if (e.key==='Backspace' && !inp.value && i>0) inputs[i-1].focus();
      });
      inp.addEventListener('paste', e=>{
        const data=(e.clipboardData||window.clipboardData).getData('text').replace(/\D/g,'').slice(0,OTP_LENGTH);
        if(!data) return;
        e.preventDefault();
        inputs.forEach((n,j)=> n.value = data[j]||'');
        inputs[Math.min(data.length-1, OTP_LENGTH-1)]?.focus();
      });
    });

    let rem=15*60; setInterval(()=>{ rem=Math.max(0,rem-1); const m=String(Math.floor(rem/60)).padStart(2,'0'), s=String(rem%60).padStart(2,'0'); timerEl.textContent=`${m}:${s}`; },1000);

    document.getElementById('otpForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const code = inputs.map(i=>i.value).join('');
      if (code.length!==OTP_LENGTH){ showErr('C√≥digo incompleto'); return; }
      const body = { code }; if (channel==='email') body.email=identity; else body.phone=identity;
      const r = await fetch('/auth/verify',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      const j = await r.json();
      if (!j.ok) return showErr(j.error || 'No se pudo verificar');
      location.href = '/';
    });

    document.getElementById('resendBtn').onclick = async ()=>{
      const body = { channel, name:'Cliente' }; if (channel==='email') body.email=identity; else body.phone=identity;
      const r=await fetch('/auth/send-code',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      const j=await r.json(); if (!j.ok) return showErr(j.error||'No se pudo reenviar');
      rem=15*60; alert('C√≥digo reenviado ‚úÖ');
    };

    function showErr(m){ errorBox.textContent = '‚ùå '+m; errorBox.style.display='block'; }
  </script>
</body>
</html>
