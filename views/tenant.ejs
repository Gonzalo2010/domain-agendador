<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title><%= org.name %> · Agenda</title>
  <style>
    /* ===== Square-like LIGHT THEME (inline) ===== */
    *,*::before,*::after{box-sizing:border-box}
    body,h1,h2,h3,p,ul,ol{margin:0;padding:0}
    ul,ol{list-style:none}
    button,input,select{font:inherit}

    :root{
      --bg:#ffffff; --txt:#111827; --muted:#6b7280; --card:#ffffff;
      --border:#e5e7eb; --accent:#111111; --accent-hover:#000000; --chip:#f3f4f6;
    }
    body{background:var(--bg);color:var(--txt);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:1080px;margin:0 auto;padding:20px}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    .muted{color:var(--muted)}
    .note{background:#f9fafb;border:1px solid var(--border);border-radius:10px;padding:10px;margin:8px 0}

    .topbar{display:flex;justify-content:space-between;align-items:center}
    .brand{display:flex;gap:10px;align-items:center}
    .logo-circle{width:40px;height:40px;border-radius:999px;background:#111;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
    .brand-title{font-weight:700}
    .brand-sub{font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:8px}

    .grid{display:grid;gap:16px}
    @media(min-width:900px){ .grid{grid-template-columns:1.6fr .8fr} }
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
    .divider{height:1px;background:var(--border);margin:10px 0}

    .btn{cursor:pointer;border:1px solid var(--border);background:#fff;padding:10px 14px;border-radius:10px}
    .btn:hover{background:#f8fafc}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff;font-weight:600}
    .btn.primary:hover{background:var(--accent-hover)}
    .btn.ghost{background:transparent;border:1px solid var(--accent);color:var(--accent)}
    .btn.link{background:transparent;border:none;color:var(--accent);padding:0}
    .wide{min-width:220px}

    .lbl{display:block;margin:10px 0}
    input,select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
    input:focus,select:focus{outline:2px solid #111;border-color:#111}

    .list{display:grid;gap:10px}
    .item{border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff}
    .inline{display:flex;gap:10px;align-items:center}
    .avatar{width:36px;height:36px;border-radius:999px;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}

    .cat-title{margin-top:16px;margin-bottom:6px}
    .svc-list{display:grid;gap:8px}
    .svc-row{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff}
    .svc-name{font-weight:600}
    .svc-meta{font-size:13px;color:var(--muted)}

    .modal-wrap{position:fixed;inset:0;background:rgba(17,24,39,.4);display:none;align-items:center;justify-content:center;padding:16px;z-index:40}
    .modal{width:100%;max-width:600px;background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.25)}
    .modal header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border)}
    .modal main{padding:16px}
    .tabs{display:flex;gap:8px;margin:8px 0}
    .tab{flex:1;border:1px solid var(--border);border-radius:10px;padding:8px 10px;cursor:pointer;background:#fff}
    .tab.active{border-color:#111;background:#f3f4f6}

    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .chip{border:1px solid var(--border);background:var(--chip);padding:8px 10px;border-radius:999px;cursor:pointer}
    .chip.active,.chip:hover{background:#e5e7eb}

    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;display:none}
  </style>
</head>
<body>
  <header class="topbar wrap">
    <div class="brand">
      <div class="logo-circle"><%= org.name[0] %></div>
      <div>
        <div class="brand-title"><%= org.name %></div>
        <div class="brand-sub">Agenda online</div>
      </div>
    </div>
    <nav class="actions">
      <button id="changeLoc" class="btn">Cambiar ubicación</button>
      <button id="openLogin" class="btn primary">Reservar / Iniciar sesión</button>
      <button id="logoutBtn" class="btn ghost">Salir</button>
    </nav>
  </header>

  <main class="wrap grid">
    <section class="card">
      <h2>Servicios</h2>
      <% if (!selectedLocationId) { %>
        <div class="note">Selecciona una ubicación para continuar.</div>
      <% } %>

      <% catalog.forEach(cat => { if (cat.services.length) { %>
        <h3 class="cat-title"><%= cat.name %></h3>
        <ul class="svc-list">
          <% cat.services.forEach(s => { %>
            <li class="svc-row">
              <div class="svc-info">
                <div class="svc-name"><%= s.name %></div>
                <div class="svc-meta"><%= Math.round(s.price_cents/100).toLocaleString('es-ES') %> € · <%= s.duration_min %> min</div>
              </div>
              <div class="svc-cta">
                <a class="btn" href="/book/<%= s.id %>">Reservar ahora</a>
              </div>
            </li>
          <% }) %>
        </ul>
      <% } }) %>
    </section>

    <aside class="card">
      <h3>Tu cuenta</h3>
      <p class="muted">Inicia sesión para ver tus próximas citas.</p>
      <div class="inline">
        <button id="toMyAppts" class="btn">Mis citas</button>
      </div>
      <div class="divider"></div>
      <h3>WhatsApp</h3>
      <div id="waStatus" class="muted">Comprobando estado…</div>
      <div class="inline">
        <a class="btn" href="/whatsapp/qr" target="_blank">Ver QR</a>
        <a class="btn" href="/qr.png" target="_blank">/qr.png</a>
      </div>
    </aside>
  </main>

  <!-- Modal ubicación -->
  <div id="locModal" class="modal-wrap" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header><strong>Cambiar ubicación</strong><button class="btn" id="closeLoc">✕</button></header>
      <main>
        <ul class="list">
          <% locations.forEach(l => { %>
            <li class="item inline">
              <input type="radio" name="loc" value="<%= l.id %>" <%= l.id===selectedLocationId ? 'checked' : '' %> />
              <div style="flex:1">
                <div><strong><%= l.name %></strong></div>
                <div class="muted"><%= l.address %> — <%= l.city %></div>
              </div>
            </li>
          <% }) %>
        </ul>
        <div class="inline" style="justify-content:flex-end;margin-top:10px">
          <button class="btn primary" id="saveLoc">Confirmar punto de venta</button>
        </div>
      </main>
    </div>
  </div>

  <!-- Modal login (envía OTP y redirige a /verify) -->
  <div id="loginModal" class="modal-wrap" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header><strong>Acceso de clientes</strong><button class="btn" id="closeLogin">✕</button></header>
      <main>
        <div class="tabs">
          <button class="tab active" data-channel="whatsapp">WhatsApp</button>
          <button class="tab" data-channel="email">Email</button>
        </div>
        <form id="sendForm">
          <label class="lbl" id="lblPhone">Teléfono<input name="phone" placeholder="+34..." inputmode="tel"/></label>
          <label class="lbl" id="lblEmail" style="display:none">Email<input name="email" type="email" placeholder="cliente@correo.com"/></label>
          <input type="hidden" name="channel" value="whatsapp"/>
          <button class="btn primary">Enviar código</button>
          <div id="sendStatus" class="muted" style="margin-top:6px"></div>
        </form>
      </main>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const $ = s=>document.querySelector(s);
    const $$ = s=>Array.from(document.querySelectorAll(s));
    const toast = m=>{ const t=$('#toast'); t.textContent=m; t.style.display='block'; setTimeout(()=>t.style.display='none', 2200); };

    fetch('/whatsapp/status').then(r=>r.json()).then(j=>{
      $('#waStatus').textContent = j.ready ? '✅ WhatsApp conectado' : '⚠️ WhatsApp no conectado';
    }).catch(()=> $('#waStatus').textContent = 'No se pudo comprobar');

    const locModal=$('#locModal'); const openLoc=$('#changeLoc'); const closeLoc=$('#closeLoc'); const saveLoc=$('#saveLoc');
    openLoc.onclick=()=>{ locModal.style.display='flex'; locModal.setAttribute('aria-hidden','false'); };
    closeLoc.onclick=()=>{ locModal.style.display='none'; locModal.setAttribute('aria-hidden','true'); };
    locModal.addEventListener('click',(e)=>{ if(e.target===locModal) closeLoc.click(); });
    saveLoc.onclick=async ()=>{
      const chk = document.querySelector('input[name="loc"]:checked');
      if (!chk) return toast('Elige una ubicación');
      const r = await fetch('/session/location',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ location_id: chk.value }) });
      const j = await r.json(); if (!j.ok) return toast('No se pudo guardar');
      location.reload();
    };

    const loginModal=$('#loginModal'), openLogin=$('#openLogin'), closeLogin=$('#closeLogin');
    const tabs=$$('.tab'); const form=$('#sendForm'); const lblPhone=$('#lblPhone'); const lblEmail=$('#lblEmail'); const status=$('#sendStatus');
    openLogin.onclick=()=>{ loginModal.style.display='flex'; loginModal.setAttribute('aria-hidden','false'); };
    closeLogin.onclick=()=>{ loginModal.style.display='none'; loginModal.setAttribute('aria-hidden','true'); };
    loginModal.addEventListener('click',(e)=>{ if(e.target===loginModal) closeLogin.click(); });

    tabs.forEach(t=> t.onclick=()=>{
      tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active');
      form.channel.value = t.dataset.channel;
      lblPhone.style.display = t.dataset.channel==='whatsapp' ? '' : 'none';
      lblEmail.style.display = t.dataset.channel==='email' ? '' : 'none';
    });

    form.onsubmit = async (e)=>{
      e.preventDefault(); status.textContent='Enviando...';
      const fd=new FormData(form); const channel=fd.get('channel');
      const payload={ channel, name:'Cliente' };
      if (channel==='email'){ payload.email=fd.get('email'); if(!payload.email) return status.textContent='Pon tu email'; }
      else { payload.phone=fd.get('phone'); if(!payload.phone) return status.textContent='Pon tu teléfono'; }
      const r=await fetch('/auth/send-code',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const j=await r.json(); if(!j.ok) { status.textContent='Error: '+(j.error||''); return; }
      localStorage.setItem('agendador_session_channel', channel);
      localStorage.setItem('agendador_session_identity', payload.email || payload.phone);
      location.href = j.verify_url;
    };

    $('#toMyAppts').onclick=()=>{
      const ch = localStorage.getItem('agendador_session_channel');
      const id = localStorage.getItem('agendador_session_identity');
      if (!ch || !id) return toast('Primero inicia sesión');
      location.href = `/me/appointments?channel=${encodeURIComponent(ch)}&identity=${encodeURIComponent(id)}`;
    };

    $('#logoutBtn').onclick=async ()=>{ await fetch('/auth/logout',{method:'POST'}); toast('Sesión cerrada'); };
  </script>
</body>
</html>
