<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title><%= org.name %> · Agenda</title>
  <link rel="stylesheet" href="<%= cdn %>/styles.css"/>
</head>
<body>
  <header class="topbar wrap">
    <div class="brand">
      <div class="logo-circle"><%= org.name[0] %></div>
      <div>
        <div class="brand-title"><%= org.name %></div>
        <div class="brand-sub">Agenda online</div>
      </div>
    </div>
    <nav class="actions">
      <button id="changeLoc" class="btn">Cambiar ubicación</button>
      <button id="openLogin" class="btn primary">Reservar / Iniciar sesión</button>
      <button id="logoutBtn" class="btn ghost">Salir</button>
    </nav>
  </header>

  <main class="wrap grid">
    <section class="card">
      <h2>Servicios</h2>
      <% if (!selectedLocationId) { %>
        <div class="note">Selecciona una ubicación para continuar.</div>
      <% } %>

      <% catalog.forEach(cat => { if (cat.services.length) { %>
        <h3 class="cat-title"><%= cat.name %></h3>
        <ul class="svc-list">
          <% cat.services.forEach(s => { %>
            <li class="svc-row">
              <div class="svc-info">
                <div class="svc-name"><%= s.name %></div>
                <div class="svc-meta"><%= Math.round(s.price_cents/100).toLocaleString('es-ES') %> € · <%= s.duration_min %> min</div>
              </div>
              <div class="svc-cta">
                <a class="btn" href="/book/<%= s.id %>">Reservar ahora</a>
              </div>
            </li>
          <% }) %>
        </ul>
      <% } }) %>
    </section>

    <aside class="card">
      <h3>Tu cuenta</h3>
      <p class="muted">Inicia sesión para ver tus próximas citas.</p>
      <div class="inline">
        <button id="toMyAppts" class="btn">Mis citas</button>
      </div>
      <div class="divider"></div>
      <h3>WhatsApp</h3>
      <div id="waStatus" class="muted">Comprobando estado…</div>
      <div class="inline">
        <a class="btn" href="/whatsapp/qr" target="_blank">Ver QR</a>
        <a class="btn" href="/qr.png" target="_blank">/qr.png</a>
      </div>
    </aside>
  </main>

  <!-- Modal ubicación -->
  <div id="locModal" class="modal-wrap" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header><strong>Cambiar ubicación</strong><button class="btn" id="closeLoc">✕</button></header>
      <main>
        <ul class="list">
          <% locations.forEach(l => { %>
            <li class="item inline">
              <input type="radio" name="loc" value="<%= l.id %>" <%= l.id===selectedLocationId ? 'checked' : '' %> />
              <div style="flex:1">
                <div><strong><%= l.name %></strong></div>
                <div class="muted"><%= l.address %> — <%= l.city %></div>
              </div>
            </li>
          <% }) %>
        </ul>
        <div class="inline" style="justify-content:flex-end;margin-top:10px">
          <button class="btn primary" id="saveLoc">Confirmar punto de venta</button>
        </div>
      </main>
    </div>
  </div>

  <!-- Modal login (envía OTP y redirige a /verify) -->
  <div id="loginModal" class="modal-wrap" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header><strong>Acceso de clientes</strong><button class="btn" id="closeLogin">✕</button></header>
      <main>
        <div class="tabs">
          <button class="tab active" data-channel="whatsapp">WhatsApp</button>
          <button class="tab" data-channel="email">Email</button>
        </div>
        <form id="sendForm">
          <label class="lbl" id="lblPhone">Teléfono<input name="phone" placeholder="+34..." inputmode="tel"/></label>
          <label class="lbl" id="lblEmail" style="display:none">Email<input name="email" type="email" placeholder="cliente@correo.com"/></label>
          <input type="hidden" name="channel" value="whatsapp"/>
          <button class="btn primary">Enviar código</button>
          <div id="sendStatus" class="muted" style="margin-top:6px"></div>
        </form>
      </main>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const $ = s=>document.querySelector(s);
    const $$ = s=>Array.from(document.querySelectorAll(s));
    const toast = m=>{ const t=$('#toast'); t.textContent=m; t.style.display='block'; setTimeout(()=>t.style.display='none', 2200); };

    // Estado WA
    fetch('/whatsapp/status').then(r=>r.json()).then(j=>{
      $('#waStatus').textContent = j.ready ? '✅ WhatsApp conectado' : '⚠️ WhatsApp no conectado';
    }).catch(()=> $('#waStatus').textContent = 'No se pudo comprobar');

    // Cambiar ubicación
    const locModal=$('#locModal'); const openLoc=$('#changeLoc'); const closeLoc=$('#closeLoc'); const saveLoc=$('#saveLoc');
    openLoc.onclick=()=>{ locModal.style.display='flex'; locModal.setAttribute('aria-hidden','false'); };
    closeLoc.onclick=()=>{ locModal.style.display='none'; locModal.setAttribute('aria-hidden','true'); };
    locModal.addEventListener('click',(e)=>{ if(e.target===locModal) closeLoc.click(); });
    saveLoc.onclick=async ()=>{
      const chk = document.querySelector('input[name="loc"]:checked');
      if (!chk) return toast('Elige una ubicación');
      const r = await fetch('/session/location',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ location_id: chk.value }) });
      const j = await r.json(); if (!j.ok) return toast('No se pudo guardar');
      location.reload();
    };

    // Login
    const loginModal=$('#loginModal'), openLogin=$('#openLogin'), closeLogin=$('#closeLogin');
    const tabs=$$('.tab'); const form=$('#sendForm'); const lblPhone=$('#lblPhone'); const lblEmail=$('#lblEmail'); const status=$('#sendStatus');
    openLogin.onclick=()=>{ loginModal.style.display='flex'; loginModal.setAttribute('aria-hidden','false'); };
    closeLogin.onclick=()=>{ loginModal.style.display='none'; loginModal.setAttribute('aria-hidden','true'); };
    loginModal.addEventListener('click',(e)=>{ if(e.target===loginModal) closeLogin.click(); });

    tabs.forEach(t=> t.onclick=()=>{
      tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active');
      form.channel.value = t.dataset.channel;
      lblPhone.style.display = t.dataset.channel==='whatsapp' ? '' : 'none';
      lblEmail.style.display = t.dataset.channel==='email' ? '' : 'none';
    });

    form.onsubmit = async (e)=>{
      e.preventDefault(); status.textContent='Enviando...';
      const fd=new FormData(form); const channel=fd.get('channel');
      const payload={ channel, name:'Cliente' };
      if (channel==='email'){ payload.email=fd.get('email'); if(!payload.email) return status.textContent='Pon tu email'; }
      else { payload.phone=fd.get('phone'); if(!payload.phone) return status.textContent='Pon tu teléfono'; }
      const r=await fetch('/auth/send-code',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const j=await r.json(); if(!j.ok) { status.textContent='Error: '+(j.error||''); return; }
      // guarda para luego mis-citas
      localStorage.setItem('agendador_session_channel', channel);
      localStorage.setItem('agendador_session_identity', payload.email || payload.phone);
      location.href = j.verify_url;
    };

    // Mis citas
    $('#toMyAppts').onclick=()=>{
      const ch = localStorage.getItem('agendador_session_channel');
      const id = localStorage.getItem('agendador_session_identity');
      if (!ch || !id) return toast('Primero inicia sesión');
      location.href = `/me/appointments?channel=${encodeURIComponent(ch)}&identity=${encodeURIComponent(id)}`;
    };

    // Logout
    $('#logoutBtn').onclick=async ()=>{ await fetch('/auth/logout',{method:'POST'}); toast('Sesión cerrada'); };
  </script>
</body>
</html>
